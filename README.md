
# SDRAM Controller for Lattice ECP5 (Verilog)

This is a lightweight, open-source SDRAM controller written in Verilog, targeting Lattice ECP5 FPGAs (e.g., using Lattice Diamond tools). It supports a standard 3.3V SDRAM chip with 16-bit data bus, 13-bit row address, 9-bit column address, and 4 banks (e.g., 64 Mbit or 128 Mbit devices such as AS4C4M16S or similar).

The design consists of a simple PLL to generate the required clocks and a hand-written SDRAM controller with proper initialization, auto-refresh handling, and support for byte, half-word, and word accesses on a 32-bit host interface.

## Top-level SDRAM Module I/O (`sdram.v`)

The main user-facing module is `sdram`. It provides a synchronous 32-bit wishbone-like interface to the host system.

### Inputs
| Signal          | Width | Description                                                                 |
|-----------------|-------|-----------------------------------------------------------------------------|
| `clk`           | 1     | System clock (typically 100 MHz, generated by PLL from 25 MHz input)       |
| `rst`           | 1     | Synchronous active-high reset                                               |
| `enable`        | 1     | Assert high to start a new read or write transaction                        |
| `addr`          | 25    | Byte address (25 bits → 32 MiB address space, suitable for 64 Mbit SDRAM)   |
| `write`         | 1     | Direction: 1 = write, 0 = read                                              |
| `write_data`    | 32    | Data to write (only used when `write == 1`)                                 |
| `data_width`    | 2     | Access size:<br>• `2'b00` = byte (8-bit)<br>• `2'b01` = half-word (16-bit)<br>• `2'b10` = word (32-bit, only addr is aligned to halfword) |

### Outputs
| Signal          | Width | Description                                                                 |
|-----------------|-------|-----------------------------------------------------------------------------|
| `read_data`     | 32    | Data read from SDRAM (valid when `ready` asserts after a read)              |
| `ready`         | 1     | Goes low when the op is accepted, goes high when completed                  |

### SDRAM Physical Pins
| Signal          | Direction | Width | Description                                      |
|-----------------|-----------|-------|--------------------------------------------------|
| `SDRAM_CLK`     | output    | 1     | Clock to SDRAM (inverted phase from internal clk)|
| `SDRAM_CKE`     | output    | 1     | Clock enable                                     |
| `SDRAM_CS_N`    | output    | 1     | Chip select (low active)                         |
| `SDRAM_RAS_N`   | output    | 1     | Row address strobe (low active)                  |
| `SDRAM_CAS_N`   | output    | 1     | Column address strobe (low active)               |
| `SDRAM_WE_N`    | output    | 1     | Write enable (low active)                        |
| `SDRAM_A`       | output    | 13    | Address bus                                      |
| `SDRAM_BA`      | output    | 2     | Bank address                                     |
| `SDRAM_DQ`      | inout     | 16    | Bidirectional data bus                           |
| `SDRAM_DQML`    | output    | 1     | Data mask lower byte                             |
| `SDRAM_DQMH`    | output    | 1     | Data mask upper byte                             |

### Usage Example
```verilog
sdram u_sdram (
    .clk        (clk_100mhz),
    .rst        (rst),
    .enable     (req_valid),
    .addr       (host_addr[24:0]),
    .write      (host_write),
    .write_data (host_wdata),
    .data_width (host_size),   // 00=byte, 01=hword, 10=word
    .read_data  (host_rdata),
    .ready      (req_ready),

    // SDRAM pins...
);
```


## File Structure

| File            | Description                                                                 |
|-----------------|-----------------------------------------------------------------------------|
| `pll.v`         | PLL instantiation using Lattice ECP5 EHXPLLL primitive.<br>Generates:<br>• `clkout0` = 25 MHz (same as input, 0° phase)<br>• `clkout1` = 100 MHz (0° phase)|
| `sdram_raw.v`   | Core SDRAM controller |
| `sdram.v`       | Wrapper around `sdram_raw` that adds support for unaligned 32-bit(when aligned to halfword), 16-bit, and 8-bit accesses.This is the recommended top-level module for integration. |
